<!doctype html> 
<html> 
  <head> 
    <meta charset="utf-8" /> 
    <title>Dresden Files Alchemy</title> 
    <script src="jquery-1.4.4.min.js"></script>
    <script src="jquery-ui-1.8.6.custom.min.js"></script>
    <script src="game_data.js"></script>
    <link rel="icon" type="image/png" href="img/favicon.png" />
  </head> 
  <body> 
  <script>
    var genealogy=new Array(3);
    var names=new Array();
    var trashHelper=1;
    var progress=new Array();
    var connections1=new Array();
    var connections2=new Array();

    $(document).ready(function(){
      genealogy = genealogyData;
      names = namesData;
      loadProgress();
      $('#options ul').css({marginLeft: -(($('#options ul').width())-($('#options span').width()))});
      init();
    });
    
    $(window).resize(function()
    {
      width=$(window).width();
      height=$(window).height();
      if(width>=1050)libWidth=580;
      else if(width>=900)libWidth=450;
      else if(width>=640) libWidth=306;
      else libWidth=176; 
      if(width<400)width=400;
      if(height<350)height=350;
      $('body').css({width: width, height: height});
      $('#table').css({width: (width-libWidth), height: (height-35), marginTop: 35});
      $('#library').css({height: height, width: libWidth});
      $('#statusBar').css({width: (width-libWidth)});
      $('#trash').css({top: (height-180), left:(width-libWidth-155)});
      $('.tablebox').each(function(){
        if(ifLeaveTable(this))$(this).fadeOut("normal",function(){$(this).remove()});
      });
    });
    
    $('#options span').live('click',function(){
      $('#options ul').toggle('fast');
    });
    
    $('#trash').live('mouseenter mouseleave', function(event) {
      switch(event.type){
        case 'mouseenter': if(trashHelper==1){$('#trash img').animate({height: 60, width: 50, marginTop: 90, marginLeft: 90}, "fast");} trashHelper=0; break;
        case 'mouseleave' : $('#trash img').animate({height: 30, width: 25, marginTop: 120, marginLeft: 115}, "fast",function(){trashHelper=1;}); break;
      }
    });
      
    $('#trash img').live('click',function(){
      $('.tablebox').each(function(){$(this).fadeOut("normal",function(){$(this).remove()})});
    });
    
    $('[type="checkbox"]').live('click',function(){saveProgress(); if($('#autosort:checked').val()!=null)librarySort();});
    
    function init()
    {
      width=$(document).width();
      height=$(document).height();
      if(width>=1050)libWidth=580;
      else if(width>=900)libWidth=450;
      else if(width>=640) libWidth=306;
      else libWidth=176; 
      $('body').css({width: width, height: height});
      $('#table').css({width: (width-libWidth), height: (height-35), marginTop: 35});
      $('#library').css({height: height, width: libWidth});
      $('#statusBar').css({width: (width-libWidth)});
      $('#trash').css({top: (height-180), left:(width-libWidth-155)});
      $('#trash').droppable({
        over: function(event, ui){
          $('#trash img').animate({height: 100, width: 85, marginTop: 50, marginLeft: 50}, "fast"); trashHelper=0;},
        out: function(event, ui){
          $('#trash img').animate({height: 30, width: 25, marginTop: 120, marginLeft: 115}, "fast"); trashHelper=1;},
        drop: function(event, ui){
          $(ui.helper).fadeOut("normal",function(){$(ui.helper).remove()})
          $('#trash img').animate({height: 30, width: 25, marginTop: 120, marginLeft: 115}, "fast");}
      });
      
      addLibraryContent();
      $("#progress").html('progress: '+progress.length+"/"+(names.length-1));
    }
    
    function addLibraryContent()
    {
      content='';
      for(i=0;i<progress.length;i++)
      {
        div='<div rel="'+(progress[i])+'" class="box libbox el'+progress[i]+'"></div>';
        content+=div;  
      }
      $('#library').html(content);
      
      $('.libbox').each(function(){
        createBoxContent(this);
      });
      $('.libbox').draggable({helper: "clone", scroll: false, 
        stop: function(event,ui){
          if((ui.offset.top < height-265) || (ui.offset.left < width-libWidth-250))
          createNewTableBox($(this).attr('rel'),ui.offset,1,1);
        }
      });
    }
    
    function createNewLibraryBox(id)
    {
      div='<div rel="'+id+'" class="box libbox el'+id+'" style="display: none"></div>';
      $('#library').append(div);
      createBoxContent('.libbox:last');
      $('.libbox:last').fadeIn('slow');
      progress.push(id);
      saveProgress();
      $('.libbox:last').draggable({helper: "clone", scroll: false,
        stop: function(event,ui){
          createNewTableBox($(this).attr('rel'),ui.offset,1,1);
        }
      });
    }
    
    function createNewTableBox(id,position,lp,checkJustDropped)
    {
      x=position.left+lp*30;
      y=position.top+lp*40;
      if(checkJustDropped) div='<div id="justDropped" rel="'+id+'" class="box tablebox el'+id+'" style="left:'+x+'px;top:'+y+'px;"></div>'; 
      else div='<div rel="'+id+'" class="box tablebox el'+id+'" style="display: none; left:'+x+'px;top:'+y+'px;"></div>';
      $('#table').append(div);
      createBoxContent('.tablebox:last');
      if(checkJustDropped){
        justDropped=$('#justDropped');
        checkConnections(justDropped);
        justDropped.removeAttr("id");  
      }
      else $('.tablebox:last').fadeIn('slow');
      
      $('.tablebox:last').draggable({scroll: false, stop: function(event, ui){checkConnections(this);}});
    }
    
    function checkConnections(el1)
    {
      if(ifLeaveTable(el1))$(el1).fadeOut("normal",function(){$(el1).remove()});
      else{
        el2=ifSex(el1);
        kk=0;
        if(el2!=0 && el2!=-1){
          id1=$(el1).attr('rel');
          id2=$(el2).attr('rel');
          children=sex(id1,id2);
          len=children.length;
          if(len>0){
            position=$(el1).offset();
            for(i=0;i<len;i++){
                kk++
                if(kk==1)removeParents(el1,el2);
                createNewTableBox(children[i],position,i,0);
                if(!include(progress,children[i])){
                  createNewLibraryBox(children[i]);
                }
            }
            if($('#autosort:checked').val()!=null)librarySort();
          }  
        }
      }
    }
    
    function ifSex(element)
    {
      x1=$(element).css("left").replace("px", "");
      y1=$(element).css("top").replace("px", "");
      ret=0;
      $('.tablebox').each(function(){
        if(this!=element && $(this).attr("id")!="justDropped"){
          x2=$(this).css("left").replace("px", "");
          y2=$(this).css("top").replace("px", "");
          
          if(Math.abs(x2-x1)<50 && Math.abs(y2-y1)<50){  
            if(ret==0)ret=this;
            else ret=-1;
          }
        }
      });
      return ret;
    }
    
    function ifLeaveTable(el)
    {
      x=parseInt($(el).css("left").replace("px", ""))+50;
      y=parseInt($(el).css("top").replace("px", ""))+55;
      b=20;
      if(x<b || x+50>=width-libWidth || y<b+35 || height-y < b) return 1;
      else return 0; 
    }
    
    function sex(mother, daddy)
    {
      ret=new Array();
      
      if(mother<daddy){id1=mother; id2=daddy;}else{id2=mother; id1=daddy;}
      helper=0;
      for(i=0;i<connections1.length;i++)if(connections1[i]==id1 && connections2[i]==id2){helper=1; break;}
      
      if(helper==0 || $('#combine:checked').val()==null)
      {  
        if(helper==0){connections1.push(id1); connections2.push(id2);}
        len=genealogy[0].length;
        for(i=0;i<len;i++)
        {
          if(genealogy[1][i]==mother)
            if(genealogy[2][i]==daddy){
              ret.push(genealogy[0][i]);
              continue;                                                          
            }
          if(genealogy[2][i]==mother)
            if(genealogy[1][i]==daddy)
              ret.push(genealogy[0][i]);
        }
      }
      return ret;
    }
    
    function removeParents(el1,el2)
    {
      $(el1).fadeOut('normal');
      $(el2).fadeOut('normal');
      setTimeout(function(){$(el1).remove(); $(el2).remove();},400);
    }
    
    function createBoxContent(el){
      id=$(el).attr('rel');
      div='<div class="boxContent"><div class="boxImg" style="background:url(\'img/base/'+id+'.png\');"></div><div class="boxDescription">'+names[id]+'</div></div><div class="boxMask"></div>';
      $(el).html(div);
    }
    
    function loadProgress()
    {
      if(!localStorage.getItem("progress"))progress=[1,2,3,4,5];
      else progress=localStorage.getItem("progress").split(",");
      
      if(!localStorage.getItem("connections1"))makePastConnections(0);
      else{
        connections1=localStorage.getItem("connections1").split(",");
        connections2=localStorage.getItem("connections2").split(",");
      }
      
      if(!localStorage.getItem("autosort"))$('#autosort').attr('checked','true');
      else{
        value=localStorage.getItem("autosort");
        if(value=='false')$('#autosort').removeAttr('checked');
        else $('#autosort').attr('checked','true'); 
      }
      if(!localStorage.getItem("combine"))$('#combine').removeAttr('checked');
      else{
        value=localStorage.getItem("combine");
        if(value=='false')$('#combine').removeAttr('checked');
        else $('#combine').attr('checked','true'); 
      }
    }
    
    function saveProgress()
    {
      localStorage.setItem("progress",progress);
      $("#progress").html('progress: '+progress.length+"/"+(names.length-1));
      
      localStorage.setItem("connections1",connections1);
      localStorage.setItem("connections2",connections2);
      
      localStorage.setItem("autosort",$("#autosort").attr("checked"));
      localStorage.setItem("combine",$("#combine").attr("checked"));
    }
    
    function resetProgress()
    {
      progress=[1,2,3,4,5];
      connections1=[];
      connections2=[];
      saveProgress();
      addLibraryContent();
      $('.tablebox').remove();
    }
    
    function include(arr, obj){
      for(var i=0; i<arr.length; i++){
        if (arr[i] == obj)return true;
      }
    }
    
    function librarySort()
    {
      tab = new Array();
      k=0;
      for(i=0; i<progress.length;i++)tab[i]=names[progress[i]];
      tab.sort();
      for(i=0;i<tab.length;i++){
        for(j=0;j<names.length;j++)if(names[j]==tab[i])k=j;
        progress[i]=k;
      }
      for(i=0; i<progress.length;i++)if(progress[i]<6){progress.splice(i,1); i--;}
      progress.unshift(1,2,3,4,5);
      saveProgress();
      addLibraryContent();
    }
    
    function makePastConnections(gen)
    {
      if(gen==0){
        connections1 = [];
        connections2 = [];
      }
      else{
        for(i=0;i<gen[0].length;i++){
          if(include(progress,gen[0][i])){
            if(gen[1][i]<gen[2][i]){id1=gen[1][i]; id2=gen[2][i];} else{id2=gen[1][i]; id1=gen[2][i];}
            connections1.push(id1);
            connections2.push(id2);
          }
        }
        saveProgress();
      }
    }    
    
    function devMode(state){
      if(state=='on'){
        $('#dev').fadeIn('normal');
      }
      else if(state=='off'){
        $('#dev').fadeOut('normal');
      }
    }
  </script> 
  
  <style> 
    body,html{
      background:#000;
      margin:0;
      overflow:hidden;
      -webkit-user-select:none;
      font-family:'Lucida Grande','Lucida Grande Unicode',Helvetica,Arial,Verdana,Sans-Serif;
    }
  
    .box{
      width:100px;
      height:110px;
      cursor:move;
      background:rgba(255,255,255,0.7);
      z-index:10;
      -webkit-border-radius:10px;      
    }
    
    .boxContent{
      width:100px;
      height:110px;
      text-align:center;
      font-family:Arial,Sans-Serif;
      color:#666;
      font-size:12pt;
      line-height:0.95;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
    }
    
    .boxImg{
      width:74px;
      height:74px;
      margin:5px 13px 0px 13px;
    }

    .boxDescription{
      margin-bottom:2px;
    }
    
    .libbox{
      z-index:20 !important;
      width:100px;
      height:110px;
    }
    
    .ui-draggable-dragging{
      z-index:20;
    }
    
    #library .box{
      margin:40px 0 0 30px;
      float:left;
    }     
    
    #table .box{
      position:absolute;
    }
    
    #table{
      float:left;
      background:#111;
    }
    
    #library{
      width:450px;
      float:left;
      background:#333;
      overflow-y:scroll;
      overflow-x:hidden;
    }
    
    #statusBar{
      width:100%;
      height:35px;
      position:absolute;
      top:0;
      background:#ddf;
      z-index:100;
    }
    
    .statusBarChild{
      height:35px;
      float:left;
    }
    
    #suggest{
      padding-top:8px;
    }
    
    #suggest a{
      text-decoration:none;
      color:#333;
      text-shadow: 1px 1px #ccc
    }    
    #options{
      float:right;
      margin:7px 10px 0 0;
      height:28px;
    }
    
    #options span{
      padding:4px 10px;
      font-size:12px;
      border-radius:5px;
      background:#333;
      color:#fff;
      cursor:pointer;
    }
    
    #options img{
      position:relative;
      top:3px;
      left:3px;
    }
    
    #options ul{
      list-style:none;
      width:350px;
      margin:0;
      padding:15px 10px;
      background:#333;
      font-size:12px;
      color:#fff;
      border-radius:5px 0 5px 5px;
      display:none;
      position:absolute;
    }
    
    #options li{
      margin:3px 0;
    }
    
    #progress{
      height:27px;
      float:right;
      font-size:16px;
      font-weight:normal;
      color:#333;
      margin:8px 20px 0 0;
      text-shadow: 1px 1px #ccc
    }
    
    #clearTable, #share{
      display:none;
    }
    
    #trash{
      width:140px;
      height:165px;
      position:absolute;
      z-index:5;
    }
    
    #trash img{
      width:25px;
      height:30px;
      margin: 120px 0px 0px 110px;
    }
    
    p{
      color:#fff;
      position:fixed;
      top:50;
      left:50;
    }
    
    #dev{
      display:none;
    }
  </style>
  <div id="statusBar">
    <div id="logo" class="statusBarChild"><div style="width:270px;height:31px;background:url('img/logo-bar.png') no-repeat;margin:3px 20px 0 20px;padding:1px 4px;"></div></div>
    <div id="options" class="statusBarChild">
      <span>Options <img src="img/arrow-options.png" style="width:15px;height:15px;" /></span>
      <ul>
        <li>
          <input type="checkbox" id="autosort"  />
          Automatically sort elements alphabetically
        </li>
        <li>
          <input type="checkbox" id="combine" />
          Don't combine elements thet were already combined
        </li>
      </ul>
    </div>
    <div id="share" class="statusBarChild">share</div>
    <div id="clearTable" class="statusBarChild">kill all</div>
    <div id="progress" class="statusBarChild"></div>
  </div>
  <div id="trash">
    <img src="img/bin.png" />
  </div> 
  <div id="table">
    <div id="dev">
      <input type="button" value="sort" onclick="librarySort()"/>
      <input type="button" value="resetProgress" onclick="resetProgress()"/>
    </div>
    <p></p>
  </div> 
  <div id="library"></div> 

  <!-- âœ… ADD TOUCH SUPPORT FOR MOBILE DRAGGING -->
  <script>
  (function($){
    $.support.touch = 'ontouchend' in document;

    if (!$.support.touch)
        return;

    var mouseProto = $.ui.mouse.prototype,
        _mouseInit = mouseProto._mouseInit,
        _mouseDestroy = mouseProto._mouseDestroy,
        touchHandled;

    function simulateMouseEvent(event, simulatedType) {
        if (event.originalEvent.touches.length > 1)
            return;

        event.preventDefault();

        var touch = event.originalEvent.changedTouches[0],
            simulatedEvent = document.createEvent('MouseEvents');

        simulatedEvent.initMouseEvent(
            simulatedType, true, true, window, 1,
            touch.screenX, touch.screenY,
            touch.clientX, touch.clientY,
            false, false, false, false, 0, null
        );

        event.target.dispatchEvent(simulatedEvent);
    }

    mouseProto._touchStart = function(event) {
        var self = this;

        if (touchHandled || !self._mouseCapture(event.originalEvent.changedTouches[0]))
            return;

        touchHandled = true;
        self._touchMoved = false;

        simulateMouseEvent(event, 'mousedown');

        $(document)
            .on('touchmove', function(e) { self._touchMove(e); })
            .on('touchend', function(e) { self._touchEnd(e); });
    };

    mouseProto._touchMove = function(event) {
        if (!touchHandled)
            return;

        this._touchMoved = true;
        simulateMouseEvent(event, 'mousemove');
    };

    mouseProto._touchEnd = function(event) {
        if (!touchHandled)
            return;

        simulateMouseEvent(event, 'mouseup');

        $(document).off('touchmove').off('touchend');
        touchHandled = false;
    };

    mouseProto._mouseInit = function() {
        this.element.on('touchstart', $.proxy(this, '_touchStart'));
        _mouseInit.call(this);
    };

    mouseProto._mouseDestroy = function() {
        this.element.off('touchstart', $.proxy(this, '_touchStart'));
        _mouseDestroy.call(this);
    };

  })(jQuery);
  </script>

  </body> 
</html>
